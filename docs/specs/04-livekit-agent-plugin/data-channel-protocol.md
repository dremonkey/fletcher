# LiveKit Data Channel Protocol: Selective Status & Markdown Artifacts

## Overview
This document specifies a lightweight protocol for the `ganglia-events` LiveKit data channel topic. It bridges OpenClaw's internal state to a mobile-friendly client (Flutter ArtifactViewer) while respecting LiveKit's bandwidth and message size constraints.

## Goals
1.  **Audio First**: Ensure data channel traffic never competes with or degrades audio quality.
2.  **Selective Status**: Filter high-frequency internal events into low-frequency, human-readable states (e.g., "Thinking", "Searching").
3.  **Markdown Artifacts**: Deliver rich content (specs, code, tasks) as "artifacts" that can be viewed independently of the voice stream.
4.  **Reliable Delivery**: Handle message fragmentation for payloads exceeding LiveKit's ~15KB data channel limit.

## Protocol Definition

### Topic
All messages are published to the `ganglia-events` topic.

### Message Structure
Messages are JSON objects. The root schema is:

```json
{
  "id": "uuid-v4",
  "timestamp": 1234567890,
  "type": "status" | "artifact" | "chunk",
  "payload": { ... }
}
```

---

### 1. Selective Status (`type: "status"`)
Only high-level state changes are broadcast. Granular tool steps (e.g., individual `grep` calls during a search) are aggregated or ignored unless they represent a distinct phase shift.

**Allowed States:**
- `thinking`: The agent is processing a request (LLM inference).
- `searching`: The agent is using search tools (grep, glob, web_search).
- `reading`: The agent is reading file content.
- `writing`: The agent is modifying files or creating content.
- `executing`: The agent is running a command.

**Payload:**
```json
{
  "state": "thinking" | "searching" | "reading" | "writing" | "executing",
  "message": "Optional user-facing label (e.g., 'Searching for auth logic...')",
  "metadata": {
    "tool": "grep", // optional debug info
    "file": "src/auth.ts" // optional context
  }
}
```

**Filtering Logic:**
- **Debounce**: Status updates should not exceed 2Hz.
- **Aggregation**: Consecutive calls to the same tool category (e.g., 3 `grep` calls) do not trigger new status events unless the `message` changes significantly.

---

### 2. Markdown Artifacts (`type: "artifact"`)
Artifacts are discrete, viewable objects generated by the agent. They are primarily Markdown but can be other text formats.

**Payload:**
```json
{
  "artifact_id": "uuid-v4",
  "kind": "markdown" | "code" | "diff",
  "title": "Short Title",
  "content": "# Full Markdown Content...",
  "path": "/path/to/source/file.md" // optional
}
```

**Artifact Generation Triggers:**
- **File Read**: When the agent reads a `.md` file, an artifact is generated.
- **Task Summary**: When `tasks/SUMMARY.md` is updated.
- **Explicit Creation**: When the agent generates a specific report or spec.

---

### 3. Chunking Protocol (`type: "chunk"`)
LiveKit data messages are limited (~15KB). Messages larger than 14KB must be split.

**Header Message:**
First, send the standard message with `content` set to `null` or empty, and a special flag indicating chunking.
*Actually, to keep it simple, we wrap the whole logical message in chunks.*

**Chunk Message Structure:**
```json
{
  "type": "chunk",
  "transfer_id": "uuid-v4-of-original-message",
  "chunk_index": 0,
  "total_chunks": 5,
  "data": "base64-encoded-part"
}
```

**Reassembly Logic (Client):**
1.  Client maintains a buffer for pending `transfer_id`s.
2.  Upon receiving a `chunk`, add `data` to the buffer at `chunk_index`.
3.  When `received_chunks == total_chunks`, decode Base64, join, and parse the original JSON payload.
4.  Process the reconstructed payload as a normal `status` or `artifact` message.

---

## Implementation Plan

### Agent Side (`@knittt/livekit-agent-ganglia`)
1.  **EventInterceptor**:
    - Wraps the OpenClaw tool execution loop.
    - Implements the "Selective Status" state machine.
    - Detects large payloads and applies chunking before publishing to LiveKit.
2.  **Artifact Detector**:
    - Inspects tool outputs (specifically `read` and `write` operations).
    - If a Markdown file is read/written, constructs an `ArtifactEvent`.

### Client Side (Flutter)
1.  **GangliaClient**:
    - Subscribes to `ganglia-events`.
    - Implements the reassembly buffer for chunks.
    - Exposes a stream of `Status` and `Artifact` objects.
2.  **ArtifactViewer**:
    - UI component to render the incoming Markdown.
